heat_template_version: 2013-05-23

description: Child stack for salt minions.

parameters:
  stack-prefix:
    type: string
    description: String generated by parent stack to ease naming.
    default: ''
  private_key:
    type: string
    description: Private key used to talk to other instances in same stack.
  public_key:
    type: string
    description: Public key used to talk to other instances in same stack.
  flavor:
    type: string
    description: Flavor to use
  image:
    type: string
    description: Image name
  network:
    type: string
    description: Network to use with minion
  master:
    type: string
    description: Salt-master location
  minion-config:
    type: string
    description: minion software config
  minion-roles:
    type: string
    description: List of roles for the minion
  security_group:
    type: string
    description: Security group

resources:

  stack-string:
    type: OS::Heat::RandomString
    properties:
      length: 6
      sequence: lettersdigits

  deploy-salt-minion-1:
    type: OS::Heat::SoftwareDeployment
    properties:
      input_values:
        public_key:
          get_param: public_key
        master:
          get_param: master
      config:
        get_param: minion-config
      server:
        get_resource: minion-1 

  minion-1:
    type: OS::Nova::Server
    properties:

      name:
        str_replace:
          template: $stackprefix-rs-$stackstr-1
          params:
            $stackprefix:
              get_param: stack-prefix
            $stackstr:
              get_attr:
                - stack-string
                - value

      image: 
        get_param: image

      flavor:
        get_param: flavor

      security_groups:
        - get_param: security_group

      personality:
        /root/.ssh/coms_rsa:
          get_param: private_key
        /etc/salt/grains:
          str_replace:
            template: |
              roles: [$roles]
              replica_set: $rsname
            params:
              $roles:
                get_param: minion-roles
              $rsname:
                get_attr:
                  - stack-string
                  - value
           
      networks:
        - network: 
            get_param: network

      user_data_format: SOFTWARE_CONFIG
  deploy-salt-minion-2:
    type: OS::Heat::SoftwareDeployment
    properties:
      input_values:
        public_key:
          get_param: public_key
        master:
          get_param: master
      config:
        get_param: minion-config
      server:
        get_resource: minion-2

  minion-2:
    type: OS::Nova::Server
    properties:

      name:
        str_replace:
          template: $stackprefix-rs-$stackstr-2
          params:
            $stackprefix:
              get_param: stack-prefix
            $stackstr:
              get_attr:
                - stack-string
                - value

      image: 
        get_param: image

      flavor:
        get_param: flavor

      security_groups:
        - get_param: security_group

      personality:
        /root/.ssh/coms_rsa:
          get_param: private_key
        /etc/salt/grains:
          str_replace:
            template: |
              roles: [$roles]
              replica_set: $rsname
            params:
              $roles:
                get_param: minion-roles
              $rsname:
                get_attr:
                  - stack-string
                  - value
           
      networks:
        - network: 
            get_param: network

      user_data_format: SOFTWARE_CONFIG
  deploy-salt-minion-3:
    type: OS::Heat::SoftwareDeployment
    properties:
      input_values:
        public_key:
          get_param: public_key
        master:
          get_param: master
      config:
        get_param: minion-config
      server:
        get_resource: minion-3 

  minion-3:
    type: OS::Nova::Server
    properties:

      name:
        str_replace:
          template: $stackprefix-rs-$stackstr-3
          params:
            $stackprefix:
              get_param: stack-prefix
            $stackstr:
              get_attr:
                - stack-string
                - value

      image: 
        get_param: image

      flavor:
        get_param: flavor

      security_groups:
        - get_param: security_group

      personality:
        /root/.ssh/coms_rsa:
          get_param: private_key
        /etc/salt/grains:
          str_replace:
            template: |
              roles: [$roles]
              replica_set: $rsname
            params:
              $roles:
                get_param: minion-roles
              $rsname:
                get_attr:
                  - stack-string
                  - value
           
      networks:
        - network: 
            get_param: network

      user_data_format: SOFTWARE_CONFIG

outputs:
  minion-1-ip:
    value:
      get_attr:
        - minion-1
        - first_address
  minion-1-stdout:
    value:
      get_attr:
        - deploy-salt-minion-1
        - deploy_stdout
  minion-1-stderr:
    value:
      get_attr:
        - deploy-salt-minion-1
        - deploy_stderr
  minion-2-ip:
    value:
      get_attr:
        - minion-2
        - first_address
  minion-2-stdout:
    value:
      get_attr:
        - deploy-salt-minion-2
        - deploy_stdout
  minion-2-stderr:
    value:
      get_attr:
        - deploy-salt-minion-2
        - deploy_stderr
  minion-3-ip:
    value:
      get_attr:
        - minion-3
        - first_address
  minion-3-stdout:
    value:
      get_attr:
        - deploy-salt-minion-3
        - deploy_stdout
  minion-3-stderr:
    value:
      get_attr:
        - deploy-salt-minion-3
        - deploy_stderr
  rs-name:
    value:
      get_attr:
        - stack-string
        - value
